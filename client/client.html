<!DOCTYPE html>
<html lang="en">

<head>
    <title>Our simple HTTP server</title>
    <link rel="stylesheet" type="text/css" href="/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">
        let pageSelected = '';

        //function to parse our response
        const parseJSON = (xhr, content) => {
            //parse response (obj will be empty in a 204 updated)
            const obj = JSON.parse(xhr.response);
            //console.dir(obj);

            //if message in response, add to screen
            if(obj.message) {
                const p = document.createElement('p');
                p.textContent = `Message: ${obj.message}`;
                content.appendChild(p);
            }

            //if users in response, add to screen
            if(obj.recipes) {
                const recipeList = document.createElement('p');
                let recipes = JSON.stringify(obj.recipes);
                recipeList.textContent = recipes;
                content.appendChild(recipeList);
            }
        };

        const handleResponse = (xhr) => {
          const content = document.querySelector('#content');

          //check the status code
          switch(xhr.status) {
            case 200: //success
              content.innerHTML = `<b>Success</b>`;
              break;
            case 201: //created
              content.innerHTML = '<b>Create</b>';
              break;
            case 204: //updated (no response back from server)
              content.innerHTML = '<b>Updated (No Content)</b>';
              return;
            case 400: //bad request
              content.innerHTML = `<b>Bad Request</b>`;
              break;
            case 404:
                content.innerHTML = `<b>Are you a Game Engine? Cause you UNREAL</b>`;
                  break;
            default: //any other status code
              content.innerHTML = `Error code not implemented by client.`;
              break;
          }
            
            if (xhr.response !== ""){
                console.log(JSON.parse(xhr.response));
                parseJSON(xhr, content);
            }
        };

        const getAjax = (e, getRecipeForm) => {
            
            //grab the form's name and age fields so we can check user input
            const url = getRecipeForm.querySelector('#urlField').value;
            const type = getRecipeForm.querySelector('#methodSelect').value;
            
            const xhr = new XMLHttpRequest(); 
            
            xhr.open(type, url); 
            xhr.setRequestHeader ("Accept", 'type/JSON');    

            xhr.onload = () => handleResponse(xhr);

            xhr.send();
            
            e.preventDefault();
            //return false to prevent the browser from trying to change page
            return false;
        };
        const sendPost = (e, recipeForm) => {
            //grab the forms action (url to go to)
            //and method (HTTP method - POST in this case)
            const recipeAction = recipeForm.getAttribute('action');
            const recipeMethod = recipeForm.getAttribute('method');
            //grab the form's name and age fields so we can check user input
            const nameField = recipeForm.querySelector('#nameField');
            const tasteField = recipeForm.querySelector('#tasteField');
            
            const ingredientsField = recipeForm.querySelector('#ingredientsField');
            const brewTimeField = recipeForm.querySelector('#brewTimeField');
            //create a new Ajax request (remember this is asynchronous)
            const xhr = new XMLHttpRequest();
            //set the method (POST) and url (action field from form)
            xhr.open(recipeMethod, recipeAction);
            //set our request type to x-www-form-urlencoded
            //which is one of the common types of form data.
            //This type has the same format as query strings key=value&key2=value2
            xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            //set our requested response type in hopes of a JSON response
            xhr.setRequestHeader ('Accept', 'application/json');
            //set our function to handle the response
            xhr.onload = () => handleResponse(xhr);
            //build our x-www-form-urlencoded format. Without ajax the 
            //browser would do this automatically but it forcefully changes pages
            //which we don't want.
            //The format is the same as query strings, so key=value&key2=value2
            //The 'name' fields from the inputs are the variable names sent to
            //the server. 
            //So ours might look like  name=test&age=22
            //Again the 'name' fields in the form are the variable names in the string
            //and the variable names the server will look for.
            const formData = `name=${nameField.value}&taste=${tasteField.value}&ingredients=${ingredientsField.value}&brewTime=${brewTimeField.value}`;
            //send our request with the data
            xhr.send(formData);
            //prevent the browser's default action (to send the form on its own)
            e.preventDefault();
            //return false to prevent the browser from trying to change page
            return false;
        };
        const init = () => {
            //grab form
            const recipeForm = document.querySelector('#recipeForm');
            const getRecipeForm = document.querySelector('#getRecipeForm');
            
            //create handler
            const addRecipe = (e) => sendPost(e, recipeForm);
            const getRecipes = (e) => getAjax(e, getRecipeForm);

            //attach submit event (for clicking submit or hitting enter)
            recipeForm.addEventListener('submit', addRecipe);
            getRecipeForm.addEventListener('submit', getRecipes);
        }; 


        window.onload = init;

  </script>
</head>

<body>
    <section id="top">
        <h3>POST Status Code Tests</h3>
        <form id="recipeForm" action="/addRecipe" method="post">
            <label for="name">Name: </label>
            <input id="nameField" type="text" name="name" />
            <label for="taste">Taste: </label>
            <input id="tasteField" type="text" name="taste" min="0" max="100" step="1" />
            <label for="ingredients">Ingredients: </label>
            <input id="ingredientsField" type="text" name="ingredients" min="0" max="100" step="1" />
            <label for="brewTime">Brew Time: </label>
            <input id="brewTimeField" type="number" name="brewTime" min="0" max="100" step="1" />
            <input type="submit" value="Add Recipe" />
        </form>
        <form id="getRecipeForm" action="/getRecipess" method="get">
            <select id='urlField'>
                <option value='/getRecipes'>/getRecipes</option>
                <option value='/notReal'>/notReal</option>
            </select>
            <select id="methodSelect">
                <option value="get">GET</option>
                <option value="head">HEAD</option>
            </select>
            <input type="submit" value="Get User" />
        </form>
    </section>
    <section id="content">
    </section>
</body>

</html>